> 编者：
> 
>     SZTU悍匠平步电控
> 
> 参考文章：
> 
> 1. [图说卡尔曼滤波，一份通俗易懂的教程 - 论智的文章 - 知乎](https://zhuanlan.zhihu.com/p/39912633)
> 
> 2. [从全状态观测器到卡尔曼滤波器（四） - 韭菜的菜的文章 - 知乎](https://zhuanlan.zhihu.com/p/339325456)（系列）

# 卡尔曼滤波：让估计的状态尽可能接近真实值

## 1.预测：根据$k-1$时刻状态预测$k$时刻状态

#### 1.1 质量为m的机器人匀速自由运动

定义机器人的状态为$X$，由于状态$X$与位置$x$和速度$x'$有关，定义状态$X=\begin{bmatrix}x \\x' \end{bmatrix} $

x和x'存在关系，将x和x'的关系，用协方差矩阵表示，可得：不确定性$P=\begin{bmatrix}\sum_{xx} \sum_{xx'} \\\sum_{x'x} \sum_{x'x'} \end{bmatrix}$

> $i$和$j$间的关系可用协方差矩阵$\sum_{ij}$表示
> 
> 矩阵$i,j$位置的元素是第$i$个变量和第$j$个变量之间的相关程度(协方差)

根据运动学，可得：$x_k=x_{k-1}+\Delta t x'_{k-1},x'_k=x'_{k-1}$

令$X_k^-=AX_{k-1}^+$，可得：$A=\begin{bmatrix}1&\Delta t\\0&1\end{bmatrix}$

令$P_k^-=AP_{k-1}^+A^T$

> $Cov(x)=\sum$，则$Cov(Ax)=A\sum A^T$

#### 1.2 外部给该机器人力$F$，沿机器人运动正方向，并考虑外部不可控扰动Q

根据运动学，可得：$x_k=x_{k-1}+\Delta t x'_{k-1}+\frac{1}{2}\frac{F}{m}\Delta t^2,x'_k=x'_{k-1}+\frac{F}{m}\Delta t,x_k''=\frac{F}{m}$

令$u=\begin{bmatrix}F\end{bmatrix}$，$X_k^-=AX_{k-1}^++Bu_{k-1}$，可得：$B=\begin{bmatrix}\frac{\Delta t^2}{2m}\\ \frac{\Delta t}{m}\end{bmatrix}$

令$P_k^-=AP_{k-1}^+A^T+\Gamma Q \Gamma^T$，其中， $\Gamma$一般为单位阵$I$

## 2. 更新：融合预测值$X_k^-$与$k$时刻传感器测量值$z_k$

令$X_k^+=X_k^-+K_k(z_k-HX_k^-)$，即最终估计的系统当前状态

令$P_k^+=\Gamma P_k^- -K_kHP_k^-$，即估计状态的不确定性

其中卡尔曼增益$K_k=\frac{P_k^-H^T}{HP_k^-H^T+R}$，$H$一般为单位阵$I$

$Q,R$需根据实际调整 ，相信测量值则调小$R$，相信预测值则调小$Q$

## 3.反馈：

$X_k^+,P_k^+$进入下一轮卡尔曼滤波

经过多轮滤波，不确定性$P$越来越小，即实现状态$X$尽可能接近真实值

> <区分>控制器：根据目标值与$X_k^+$的差值计算力$F$,作为$u$输入系统，使系统趋于目标值

# [从全状态观测器到卡尔曼滤波器（六） - 知乎](https://zhuanlan.zhihu.com/p/350974281)中有关卡尔曼滤波的代码逻辑

```main.c
int main()
1. 初始化IMU
2. 初始化卡尔曼滤波器
    2.1 X = [gx,gy,gz]
    2.2 H对角单位矩阵
    2.3 I对角单位矩阵
    2.4 P_pred= [100, 0.1  , 0.1,
                 0.1 , 100 , 0.1,
                 0.1 , 0.1 , 100]
    2.5 Q对角矩阵 对角为过程噪声
    2.6 R对角矩阵 对角为观测噪声
while(1)
{
    3. 获得处理后的IMU数据：gx,gy,gz,ax,ay,az
    4. 卡尔曼滤波更新：
        4.1 A = [  1   , gz*dt  ,-gy*dt;
                -gz*dt ,    1   , gx*dt;
                 gy*dt , -gx*dt ,   1   ]
        4.2 X_prev = A * X
        4.3 P_prev = A * P_pred * A^T + Q
        4.4 Z = [ax,ay,az]
        4.5 K = P_prev * (P_prev + R)^-1
        4.6 err = z - X_prev
        4.7 X_pred = X_prev + K*err
        4.8 P_pred = (I - K) * P_prev
}
```
