close all;
clear;clc;

% ============================= 1.1 机械量 ============================= %

    theta_0 = 0;
    phi_0 = 0;

    R = 0.155/2;            % 轮毂半径
    l = 0.02363;            % 机体重心到机体转轴的距离
    B_L = 0.554;            % 机体长度（x方向）
    % B_L = 0.554 + 0.240;  % 机体长度（x方向 加云台） 
    B_W = 0.200;            % 机体宽度（y方向） 
    B_H = 0.167;            % 机体高度（z方向） 
    L_0 = 0.35;             % 腿长 

    m_w = 0.167;            % 轮毂质量（不含轮毂电机）
    m_p = 1.865;            % 摆杆质量（含轮毂电机不含关节电机）
    M = 11.255;             % 机体质量（含关节电机 纯底盘）
    % M = 11.255 + 2.494;   % 机体质量（含关节电机 加云台）

    g = 9.80665;            % 重力加速度

% ============================= 1.2 距离 ============================= %

    %此处理想化

    L = L_0/2;                               % 摆杆重心到轮毂轴线的距离 
    L_M = L_0/2;                             % 摆杆重心到机体转轴的距离
 
% ============================= 1.2 转动惯量 ============================= %
    
    I_w = (1/2)*m_w*R^2;                            % 轮毂转子的转动惯量
    I_M = (1/12)*M*(B_L^2+B_H^2);                   % 机体绕质心的转动惯量（x轴）
    I_p = (1/12) * m_p * ((L + L_M)^2 + 0.05^2);    % 摆杆绕质心的转动惯量

% ===================== 1.6 M矩阵 (1.3-1.5为推导) ===================== %

    M11 = I_p + m_p*L^2 + M*(L + L_M)^2;
    M12 = (m_p + M)*L + M*L_M;
    M13 = -M*l*(L + L_M);
    
    M21 = m_p*L*R + M*R*(L + L_M);
    M22 = I_w/R + R*(m_w + m_p + M);
    M23 = -R*M*l;
    
    M31 = -M*l*(L + L_M);
    M32 = -M*l;
    M33 = I_M + M*l^2;

    M_mat = [ M11,  M12,  M13 ;
              M21,  M22,  M23 ;
              M31,  M32,  M33 ];

% ============================= 1.6 Z矩阵 ============================= %

    Z11 = (m_p + M)*g*L + M*g*L_M;
    Z32 = M*g*l;
    
    Z_mat = [ Z11,    0,   -1,    1 ;
                0,    0,    1,    0 ;
                0,  Z32,    0,    1 ];

% ============================= 1.7 G矩阵 ============================= %

    G = M_mat \ Z_mat;

% ============================= 1.9 A矩阵 ============================= %
   
    A_mat = [      0,       1,       0,       0,       0,       0 ;
              G(1,1),       0,       0,       0,  G(1,2),       0 ;
                   0,       0,       0,       1,       0,       0 ;
              G(2,1),       0,       0,       0,  G(2,2),       0 ;
                   0,       0,       0,       0,       0,       1 ;
              G(3,1),       0,       0,       0,  G(3,2),       0 ];

% ============================= 1.8 B矩阵 ============================= %
    
    B_mat = [      0,        0 ;
              G(1,3),   G(1,4) ;
                   0,       0 ;
              G(2,3),   G(2,4) ;
                   0,        0 ;
              G(3,3),   G(3,4) ];
    
% ============================= 2.1 Q矩阵 ============================= %
    
    % 根据实际情况设定Q
    % 权重顺序: θ, θ', x, x', φ, φ'

    Q_mat = diag([1 1 400 1 4000 1]);

% ============================= 2.1 R矩阵 ============================= %

    %根据实际情况设定R
    % 权重顺序: 轮毂 关节

    R_mat = diag([1, 0.25]);

% ============================= 2.2 K矩阵 ============================= %
    
    dt = 0.001;
    K = lqrd(A_mat, B_mat, Q_mat, R_mat, dt);

% % ============================= 模拟系统响应 ============================= %
% 
% % 创建新窗口，编号1
% figure(1); 
% 
% % 初始状态
% x0=[   phi_0 ;
%            0 ;
%            0 ;
%            0 ;
%      theta_0 ;
%            0 ];
% 
% t=0:dt:4;
% 
% u=[ zeros(size(t));
%     zeros(size(t));];
% 
% C_mat=[ 1   0   0   0   0   0;
%         0   1   0   0   0   0;
%         0   0   1   0   0   0;
%         0   0   0   1   0   0;
%         0   0   0   0   1   0;
%         0   0   0   0   0   1];
% D_mat=[ 0   0;
%         0   0;
%         0   0;
%         0   0;
%         0   0;
%         0   0];
% 
% [y,x]=lsim(A_mat-B_mat*K,B_mat,C_mat,D_mat,u,t,x0);
% 
% % 添加图例
% plot(t,y);
% grid on; % 添加网格线
% title('系统状态响应曲线');
% xlabel('时间 (s)');
% ylabel('状态响应');
% legend('θ(t)','dθ(t)','x(t)','dx(t)','ɸ','dɸ');

fprintf('运行结束，当前时间：%s\n', datetime("now"));